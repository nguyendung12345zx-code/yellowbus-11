<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Learning Pro (V23)</title>
    <style>
        /* === å…¨å±€æ ·å¼ === */
        :root { --primary: #2979FF; --bg-grey: #F5F7FA; --text-main: #333; --green: #4CAF50; }
        body { margin: 0; font-family: "Comic Sans MS", -apple-system, sans-serif; background: var(--bg-grey); height: 100vh; overflow: hidden; display: flex; flex-direction: column; color: var(--text-main); }
        
        /* === é¡¶éƒ¨å¯¼èˆªæ  === */
        header { 
            height: 50px; background: white; border-bottom: 1px solid #E0E0E0; 
            display: flex; align-items: center; padding: 0 10px; gap: 8px;
            flex-shrink: 0; overflow-x: auto; /* é˜²æ­¢å°å±æº¢å‡º */
        }
        .back-btn { border: 1px solid #ddd; background: white; padding: 4px 10px; border-radius: 20px; cursor: pointer; color: #555; font-size: 12px; white-space: nowrap; }
        
        .nav-group { display: flex; align-items: center; gap: 4px; border-right: 1px solid #eee; padding-right: 8px; margin-right: 4px; }
        .speed-label { font-size: 12px; color: #888; display: none; /* æ‰‹æœºä¸Šéšè—æ–‡å­—æ ‡ç­¾çœç©ºé—´ */ }
        .speed-btn { 
            border: 1px solid #ddd; background: #f9f9f9; padding: 4px 6px; border-radius: 4px; 
            cursor: pointer; font-size: 12px; min-width: 30px;
        }
        .speed-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        #play-all-btn {
            background: var(--green); color: white; border: 1px solid var(--green); 
            font-weight: bold; padding: 4px 10px; font-size: 12px; display: flex; align-items: center; gap: 4px; white-space: nowrap;
        }
        #play-all-btn.playing { background: #E53935; border-color: #E53935; }

        /* === ä¸»å¸ƒå±€ (Flex Column é»˜è®¤) === */
        #main-container { display: flex; flex: 1; overflow: hidden; flex-direction: column; }

        /* 1. å·¦æ ï¼šå›¾ç‰‡ (æ‰‹æœºå  30%) */
        #col-left { 
            flex: 0 0 30%; /* å›ºå®šé«˜åº¦ */
            background: #ffffff; 
            display: flex; align-items: center; justify-content: center;
            padding: 10px; box-sizing: border-box; border-bottom: 1px solid #eee;
            position: relative;
        }
        #scene-img { 
            width: 100%; height: 100%; object-fit: contain; 
            border-radius: 8px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1));
        }

        /* 2. ä¸­æ ï¼šè„šæœ¬ (æ‰‹æœºå  40%) */
        #col-mid { 
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            background: var(--bg-grey); 
            overflow-y: auto; padding: 15px; 
        }

        /* 3. å³æ ï¼šå•è¯è¡¨ (æ‰‹æœºå  30%ï¼Œæ”¾åœ¨æœ€åº•) */
        #col-right { 
            display: flex; /* æ‰‹æœºå¼ºåˆ¶æ˜¾ç¤ºï¼ */
            flex-direction: column;
            flex: 0 0 30%; /* å›ºå®šé«˜åº¦ */
            background: white; 
            border-top: 2px solid #FFD54F; /* é¡¶éƒ¨åŠ ä¸ªé»„æ¡åŒºåˆ† */
            z-index: 10;
        }

        /* --- PCç«¯å“åº”å¼è°ƒæ•´ (å˜å›å·¦å³å¸ƒå±€) --- */
        @media (min-width: 768px) {
            header { height: 60px; padding: 0 20px; }
            .speed-label { display: inline; }
            
            #main-container { flex-direction: row; }
            
            #col-left { flex: 0 0 400px; height: 100%; border-right: 1px solid #ddd; border-bottom: none; }
            
            #col-mid { flex: 1; border-right: 1px solid #ddd; }
            
            #col-right { 
                flex: 0 0 300px; height: 100%; border-top: none; 
            }
        }

        /* --- å†…å®¹æ ·å¼ --- */
        .script-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .script-card.active { border-color: var(--primary); background: #E3F2FD; }
        .en-text { font-size: 18px; font-weight: 500; line-height: 1.5; margin-bottom: 8px; color: #222; }
        .cn-text { font-size: 14px; color: #666; margin-bottom: 5px; }
        .highlight-word { color: #00897B; border-bottom: 2px solid #4DB6AC; font-weight: bold; cursor: pointer; }

        .vocab-header { padding: 10px; background: #FAFAFA; font-weight: bold; font-size: 14px; color: #333; border-bottom: 1px solid #eee; text-align: center; }
        .vocab-list { flex: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }
        
        .vocab-card { 
            border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 8px; 
            background: #fff; border-left: 4px solid #ddd; position: relative; cursor: pointer;
        }
        .vocab-card.focused { border-left-color: #FF9800 !important; background-color: #FFF3E0 !important; transform: scale(1.02); }
        .vocab-top { display: flex; justify-content: space-between; align-items: center; }
        .vocab-word { font-size: 18px; font-weight: bold; color: #333; }
        .vocab-mask { margin-top: 5px; font-size: 12px; color: #999; background: #f5f5f5; padding: 4px; text-align: center; }
        .vocab-reveal { display: none; margin-top: 5px; padding-top: 5px; border-top: 1px solid #f0f0f0; font-size: 14px; }
        .vocab-card.revealed .vocab-mask { display: none; }
        .vocab-card.revealed .vocab-reveal { display: block; }
        .vocab-card.revealed { border-left-color: #4CAF50; }

        .section-divider { text-align: center; margin: 30px 0 20px 0; color: #888; font-size: 14px; }
        .quiz-card { background: #FFF3E0; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 2px dashed #FFB74D; }
        .quiz-opt { background: white; border: 1px solid #FFCC80; padding: 10px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; justify-content: space-between; }
        .quiz-opt.correct { background: #C8E6C9; border-color: #4CAF50; }
        .quiz-opt.wrong { background: #FFCDD2; border-color: #F44336; }
    </style>
</head>
<body>

    <div id="menu-screen" style="padding:40px; text-align:center;">
        <h2>ğŸ“š é­”æ³•ç²¾è¯» (V23)</h2>
        <div onclick="openBook()" style="background:white; display:inline-block; padding:20px; border-radius:15px; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
            <img src="https://via.placeholder.com/150/FDD835/FFFFFF?text=Start" style="border-radius:10px; margin-bottom:10px;">
            <h3>The Yellow Bus</h3>
            <p style="color:#666; font-size:12px;">æ‰‹æœºå®Œç¾é€‚é…ç‰ˆ</p>
        </div>
    </div>

    <div id="learning-screen" style="display:none; height:100vh; flex-direction:column;">
        <header>
            <div class="nav-group" style="border:none;">
                <button class="back-btn" onclick="location.reload()">â¬… ä¹¦æ¶</button>
            </div>
            
            <div class="nav-group" style="border:none;">
                <button class="speed-btn" onclick="setSpeed(0.5)">0.5</button>
                <button class="speed-btn" onclick="setSpeed(0.75)">0.75</button>
                <button class="speed-btn active" onclick="setSpeed(1.0)">1.0</button>
            </div>

            <button id="play-all-btn" class="speed-btn" onclick="toggleAutoPlay()">
                â–¶ å…¨æ–‡
            </button>
        </header>

        <div id="main-container">
            <div id="col-left">
                <img id="scene-img" src="images/story001_yellowbus/p1.jpg" onerror="this.src='https://via.placeholder.com/600x400?text=Image+Load+Error'">
            </div>

            <div id="col-mid"></div>

            <div id="col-right">
                <div class="vocab-header">ğŸ”‘ æ ¸å¿ƒè¯æ±‡ (ç‚¹å‡»å·¦ä¾§ç»¿å­—æŸ¥çœ‹)</div>
                <div class="vocab-list" id="vocab-container"></div>
            </div>
        </div>
    </div>

<script>
    // æ•°æ®æº
    const storyData = {
        title: "The Yellow Bus",
        paragraphs: [
            {
                text: "I go to {school} by the {yellow} {bus} every {morning}. It is a {big} and {long} car.",
                cn: "æˆ‘æ¯å¤©æ—©ä¸Šåé»„è‰²æ ¡è½¦å»ä¸Šå­¦ã€‚å®ƒæ˜¯ä¸€è¾†åˆå¤§åˆé•¿çš„è½¦ã€‚",
                img: "images/story001_yellowbus/p1.jpg", 
                vocab: { 
                    "school": { ph: "/skuËl/", pos: "n.", cn: "å­¦æ ¡" },
                    "yellow": { ph: "/Ëˆjel.oÊŠ/", pos: "adj.", cn: "é»„è‰²çš„" },
                    "bus": { ph: "/bÊŒs/", pos: "n.", cn: "å…¬å…±æ±½è½¦" },
                    "morning": { ph: "/ËˆmÉ”Ër.nÉªÅ‹/", pos: "n.", cn: "æ—©æ™¨" },
                    "big": { ph: "/bÉªÉ¡/", pos: "adj.", cn: "å¤§çš„" },
                    "long": { ph: "/lÉ‘ËÅ‹/", pos: "adj.", cn: "é•¿çš„" }
                }
            },
            {
                text: "The {driver} is Mr. Brown. He is very {nice} to us.",
                cn: "å¸æœºæ˜¯å¸ƒæœ—å…ˆç”Ÿï¼Œä»–å¯¹æˆ‘ä»¬å¾ˆå‹å–„ã€‚",
                img: "images/story001_yellowbus/p2.jpg",
                vocab: { 
                    "driver": { ph: "/ËˆdraÉª.vÉš/", pos: "n.", cn: "å¸æœº" },
                    "nice": { ph: "/naÉªs/", pos: "adj.", cn: "å‹å¥½çš„" }
                }
            },
            {
                text: "I {wait} for the bus at the bus {stop}. When the {door} {opens}, I see my {friends} {inside}.",
                cn: "æˆ‘åœ¨è½¦ç«™ç­‰è½¦ã€‚å½“è½¦é—¨æ‰“å¼€æ—¶ï¼Œæˆ‘çœ‹åˆ°æˆ‘çš„æœ‹å‹ä»¬åœ¨é‡Œé¢ã€‚",
                img: "images/story001_yellowbus/p3.jpg",
                vocab: { 
                    "wait": { ph: "/weÉªt/", pos: "v.", cn: "ç­‰å¾…" },
                    "stop": { ph: "/stÉ‘Ëp/", pos: "n.", cn: "è½¦ç«™" },
                    "door": { ph: "/dÉ”Ër/", pos: "n.", cn: "é—¨" },
                    "opens": { ph: "/ËˆoÊŠ.pÉ™nz/", pos: "v.", cn: "æ‰“å¼€" },
                    "friends": { ph: "/frendz/", pos: "n.", cn: "æœ‹å‹" },
                    "inside": { ph: "/ÉªnËˆsaÉªd/", pos: "adv.", cn: "åœ¨é‡Œé¢" }
                }
            },
            {
                text: "We {sit} together and {look} out the {window}. We {talk} and {laugh} {happily}.",
                cn: "æˆ‘ä»¬ååœ¨ä¸€èµ·çœ‹çª—å¤–ã€‚æˆ‘ä»¬å¼€å¿ƒåœ°è¯´è¯å¤§ç¬‘ã€‚",
                img: "images/story001_yellowbus/p4.jpg",
                vocab: { 
                    "sit": { ph: "/sÉªt/", pos: "v.", cn: "å" },
                    "look": { ph: "/lÊŠk/", pos: "v.", cn: "çœ‹" },
                    "window": { ph: "/ËˆwÉªn.doÊŠ/", pos: "n.", cn: "çª—æˆ·" },
                    "talk": { ph: "/tÉ‘Ëk/", pos: "v.", cn: "è¯´è¯" },
                    "laugh": { ph: "/lÃ¦f/", pos: "v.", cn: "ç¬‘" },
                    "happily": { ph: "/ËˆhÃ¦p.É™l.i/", pos: "adv.", cn: "å¿«ä¹åœ°" }
                }
            },
            {
                text: "The bus ride is {safe} and {fun}. I {love} the yellow bus.",
                cn: "åæ ¡è½¦æ—¢å®‰å…¨åˆæœ‰è¶£ã€‚æˆ‘çˆ±é»„è‰²æ ¡è½¦ã€‚",
                img: "images/story001_yellowbus/p5.jpg",
                vocab: { 
                    "safe": { ph: "/seÉªf/", pos: "adj.", cn: "å®‰å…¨çš„" },
                    "fun": { ph: "/fÊŒn/", pos: "adj.", cn: "æœ‰è¶£çš„" },
                    "love": { ph: "/lÊŒv/", pos: "v.", cn: "çˆ±" }
                }
            }
        ],
        quizzes: [
            { question: "What color is the bus?", options: ["Red", "Yellow", "Blue"], answer: 1 },
            { question: "Who is the driver?", options: ["Mr. Green", "Mr. Brown", "Mr. Black"], answer: 1 },
            { question: "Are they happy on the bus?", options: ["Yes", "No"], answer: 0 }
        ]
    };

    let currentRate = 1.0;
    let isAutoPlaying = false; 

    // åˆå§‹åŒ–
    function openBook() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('learning-screen').style.display = 'flex';
        renderContent();
        activateParagraph(0);
        // å°è¯•è§£é”éŸ³é¢‘
        if(window.speechSynthesis) window.speechSynthesis.cancel();
    }

    function renderContent() {
        const container = document.getElementById('col-mid');
        container.innerHTML = "";

        storyData.paragraphs.forEach((para, idx) => {
            let card = document.createElement('div');
            card.className = 'script-card';
            card.id = `para-${idx}`;
            
            card.onclick = (e) => {
                if(!e.target.classList.contains('highlight-word')) {
                    stopAutoPlay();
                    activateParagraph(idx);
                }
            };

            let htmlText = para.text.replace(/{(\w+)}/g, (match, word) => {
                return `<span class="highlight-word" onclick="handleWordClick('${word}', ${idx}, event)">${word}</span>`;
            });

            card.innerHTML = `<div class="en-text">${htmlText}</div><div class="cn-text">${para.cn}</div>`;
            container.appendChild(card);
        });

        // äº’åŠ¨åŒº
        let divider = document.createElement('div');
        divider.className = 'section-divider';
        divider.innerText = "â€”â€”â€” âœ¨ Quiz Time (äº’åŠ¨æŒ‘æˆ˜) âœ¨ â€”â€”â€”";
        container.appendChild(divider);

        storyData.quizzes.forEach((quiz, qIdx) => {
            let qCard = document.createElement('div');
            qCard.className = 'quiz-card';
            qCard.innerHTML = `
                <div style="font-weight:bold;color:#EF6C00;margin-bottom:8px;">Question ${qIdx + 1}</div>
                <div style="display:flex; align-items:center; margin-bottom:10px;">
                    <div style="font-weight:bold; flex:1; font-size:16px;">${quiz.question}</div>
                    <button style="border:none;background:none;font-size:20px;" onclick="stopAutoPlay(); speakText('${quiz.question}')">ğŸ”Š</button>
                </div>
                <div>
                    ${quiz.options.map((opt, oIdx) => `
                        <div class="quiz-opt" onclick="checkAnswer(this, ${oIdx}, ${quiz.answer}, '${opt}')">
                            <span>${opt}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(qCard);
        });
        
        let spacer = document.createElement('div');
        spacer.style.height = "50px";
        container.appendChild(spacer);
    }

    function handleWordClick(word, paraIdx, event) {
        event.stopPropagation();
        stopAutoPlay();
        activateParagraph(paraIdx, true); 

        const vocabCard = document.getElementById(`vocab-card-${word}`);
        if(vocabCard) {
            document.querySelectorAll('.vocab-card').forEach(el => el.classList.remove('focused'));
            if (!vocabCard.classList.contains('revealed')) vocabCard.classList.add('revealed');
            vocabCard.classList.add('focused');
            vocabCard.scrollIntoView({behavior: "smooth", block: "center"});
        }
        speakText(word);
    }

    function activateParagraph(idx, silent = false) {
        document.querySelectorAll('.script-card').forEach(el => el.classList.remove('active'));
        const activeCard = document.getElementById(`para-${idx}`);
        if(activeCard) {
            activeCard.classList.add('active');
            activeCard.scrollIntoView({behavior: "smooth", block: "center"});
        }

        document.getElementById('scene-img').src = storyData.paragraphs[idx].img;
        updateSidebar(idx);

        if (!silent) {
            let rawText = storyData.paragraphs[idx].text.replace(/{|}/g, "");
            speakText(rawText);
        }
    }

    function updateSidebar(idx) {
        const container = document.getElementById('vocab-container');
        container.innerHTML = "";
        const vocabMap = storyData.paragraphs[idx].vocab;
        
        for (let [word, info] of Object.entries(vocabMap)) {
            let card = document.createElement('div');
            card.className = 'vocab-card';
            card.id = `vocab-card-${word}`;
            
            card.onclick = function() {
                stopAutoPlay();
                document.querySelectorAll('.vocab-card').forEach(el => el.classList.remove('focused'));
                this.classList.add('focused');
                if (!this.classList.contains('revealed')) this.classList.add('revealed');
                speakText(word);
            };

            card.innerHTML = `
                <div class="vocab-top">
                    <div><span class="vocab-word">${word}</span> <span style="font-size:12px;color:#888;">${info.ph}</span></div>
                    <button style="border:none;background:none;color:#2979FF;" onclick="event.stopPropagation(); stopAutoPlay(); speakText('${word}')">ğŸ”Š</button>
                </div>
                <div class="vocab-mask">ç‚¹å‡»æŸ¥çœ‹</div>
                <div class="vocab-reveal"><span class="pos-tag">${info.pos}</span> ${info.cn}</div>
            `;
            container.appendChild(card);
        }
    }

    function toggleAutoPlay() {
        if (isAutoPlaying) stopAutoPlay();
        else startAutoPlay();
    }

    function startAutoPlay() {
        isAutoPlaying = true;
        const btn = document.getElementById('play-all-btn');
        btn.innerHTML = "â¹";
        btn.classList.add('playing');
        playNextParagraph(0);
    }

    function stopAutoPlay() {
        isAutoPlaying = false;
        window.speechSynthesis.cancel();
        const btn = document.getElementById('play-all-btn');
        btn.innerHTML = "â–¶ å…¨æ–‡";
        btn.classList.remove('playing');
    }

    function playNextParagraph(idx) {
        if (!isAutoPlaying || idx >= storyData.paragraphs.length) {
            stopAutoPlay();
            return;
        }
        activateParagraph(idx); 
        
        let rawText = storyData.paragraphs[idx].text.replace(/{|}/g, "");
        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(rawText);
        u.lang = 'en-US';
        u.rate = currentRate;
        u.onend = () => {
             if(isAutoPlaying) setTimeout(() => playNextParagraph(idx + 1), 500);
        };
        window.speechSynthesis.speak(u);
    }

    window.checkAnswer = function(el, selIdx, ansIdx, text) {
        stopAutoPlay(); 
        speakText(text);
        if(selIdx === ansIdx) el.classList.add('correct');
        else el.classList.add('wrong');
    }

    function setSpeed(rate) {
        currentRate = rate;
        document.querySelectorAll('.speed-btn').forEach(btn => {
            if (parseFloat(btn.innerText) === rate) btn.classList.add('active');
            else btn.classList.remove('active');
        });
    }

    function speakText(text) {
        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = currentRate; 
        window.speechSynthesis.speak(u);
    }
</script>
</body>
</html>