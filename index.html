<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Learning (V29 ç¨³å®šç‰ˆ)</title>
    <style>
        /* === 1. åŸºç¡€è®¾å®š === */
        :root { --primary: #2979FF; --bg: #F5F7FA; --text: #333; }
        body { 
            margin: 0; font-family: "Comic Sans MS", system-ui, sans-serif; 
            background: var(--bg); color: var(--text);
            /* æ‰‹æœºç«¯å…è®¸æ»šåŠ¨ï¼Œä¸å†å¼ºåˆ¶ä¸€å± */
            height: auto; min-height: 100vh;
        }

        /* === 2. å¯åŠ¨é®ç½©å±‚ (è§£å†³iOSæ²¡å£°éŸ³çš„å…³é”®!) === */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .start-btn {
            padding: 15px 40px; font-size: 22px; background: #FFD600; color: #333;
            border: 2px solid #333; border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 0 #333; transition: transform 0.1s;
        }
        .start-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #333; }
        .tips { margin-top: 20px; font-size: 14px; color: #666; text-align: center; line-height: 1.6; }

        /* === 3. é¡¶éƒ¨æ  === */
        header { 
            height: 50px; background: white; border-bottom: 1px solid #eee; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; position: sticky; top: 0; z-index: 100;
        }
        .controls button {
            background: #f0f0f0; border: 1px solid #ddd; padding: 5px 10px; 
            border-radius: 4px; font-size: 12px; margin-left: 5px; cursor: pointer;
        }
        .controls button.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* === 4. ä¸»å¸ƒå±€ (æ‰‹æœºä¼˜å…ˆï¼šå‚ç›´å †å ) === */
        #main-container {
            display: flex; flex-direction: column; /* æ‰‹æœºï¼šä¸Šä¸‹æ’ */
            max-width: 1200px; margin: 0 auto;
        }

        /* A. å›¾ç‰‡åŒº */
        #col-left {
            background: white; padding: 10px; text-align: center;
            border-bottom: 1px solid #eee;
        }
        #scene-img {
            max-width: 100%; height: auto; max-height: 300px; /* é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢å æ»¡æ‰‹æœºå± */
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* B. æ–‡ç« åŒº */
        #col-mid {
            padding: 20px;
        }

        /* C. å•è¯åŒº (æ‰‹æœºä¸Šæ”¾åˆ°åº•éƒ¨) */
        #col-right {
            background: white; padding: 20px; border-top: 2px solid #FFD54F;
        }

        /* === 5. PCç«¯/iPadæ¨ªå±é€‚é… (å·¦å³å¸ƒå±€) === */
        @media (min-width: 768px) {
            body { height: 100vh; overflow: hidden; } /* PCç«¯é”æ­»é«˜åº¦ï¼Œä¸æ»šåŠ¨ */
            #main-container { flex-direction: row; height: calc(100vh - 50px); }
            
            #col-left { 
                flex: 0 0 350px; border-right: 1px solid #ddd; border-bottom: none;
                display: flex; align-items: center; justify-content: center;
                background: #f9f9f9;
            }
            #col-mid { 
                flex: 1; overflow-y: auto; /* æ–‡ç« åŒºåŸŸç‹¬ç«‹æ»šåŠ¨ */
            }
            #col-right { 
                flex: 0 0 280px; border-left: 1px solid #ddd; border-top: none;
                overflow-y: auto; /* å•è¯åŒºåŸŸç‹¬ç«‹æ»šåŠ¨ */
            }
        }

        /* === å†…å®¹æ ·å¼ === */
        .script-card {
            background: white; padding: 15px; margin-bottom: 15px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid transparent;
            cursor: pointer;
        }
        .script-card.active { border-color: var(--primary); background: #E3F2FD; }
        .en-text { font-size: 18px; font-weight: 600; line-height: 1.5; margin-bottom: 8px; }
        .cn-text { font-size: 14px; color: #666; }
        .highlight { color: #009688; border-bottom: 2px solid #4DB6AC; cursor: pointer; }
        
        .vocab-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee;
        }
        .vocab-word { font-weight: bold; font-size: 16px; }
        .vocab-cn { font-size: 14px; color: #555; background: #eee; padding: 2px 6px; border-radius: 4px; }
        
        /* é”™è¯¯æç¤º */
        #error-msg { display:none; color:red; font-size:12px; margin-top:10px; }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1 style="color:#2979FF; margin-bottom: 30px;">Magic English ğŸ§</h1>
        <button class="start-btn" onclick="startApp()">å¼€å§‹å­¦ä¹  / Start</button>
        <div class="tips">
            âš ï¸ è‹¹æœæ‰‹æœº/iPadç”¨æˆ·è¯·æ³¨æ„ï¼š<br>
            è¯·åŠ¡å¿…<b>å…³é—­é™éŸ³æ¨¡å¼</b> (æ‹¨å¼€ä¾§è¾¹é™éŸ³é”®)<br>
            å¹¶è°ƒå¤§<b>åª’ä½“éŸ³é‡</b>
        </div>
    </div>

    <header>
        <div style="font-weight:bold;">ğŸ“š The Yellow Bus</div>
        <div class="controls">
            <button onclick="setSpeed(0.75)">0.75x</button>
            <button onclick="setSpeed(1.0)" class="active">1.0x</button>
            <button onclick="toggleAutoPlay()" id="play-btn">â–¶ å…¨æ–‡</button>
        </div>
    </header>

    <div id="main-container">
        <div id="col-left">
            <img id="scene-img" src="" alt="åŠ è½½ä¸­..." onerror="document.getElementById('error-msg').style.display='block'">
            <div id="error-msg">âŒ å›¾ç‰‡åŠ è½½å¤±è´¥<br>è¯·æ£€æŸ¥ images æ–‡ä»¶å¤¹å</div>
        </div>

        <div id="col-mid"></div>

        <div id="col-right">
            <div style="font-weight:bold; margin-bottom:15px; color:#555;">ğŸ”‘ æ ¸å¿ƒè¯æ±‡ (Key Words)</div>
            <div id="vocab-list"></div>
        </div>
    </div>

<script>
    // æ•°æ®
    const storyData = {
        paragraphs: [
            {
                text: "I go to {school} by the {yellow} {bus} every {morning}. It is a {big} and {long} car.",
                cn: "æˆ‘æ¯å¤©æ—©ä¸Šåé»„è‰²æ ¡è½¦å»ä¸Šå­¦ã€‚å®ƒæ˜¯ä¸€è¾†åˆå¤§åˆé•¿çš„è½¦ã€‚",
                img: "images/story001_yellowbus/p1.jpg", 
                vocab: { 
                    "school": "å­¦æ ¡", "yellow": "é»„è‰²çš„", "bus": "å…¬äº¤è½¦", 
                    "morning": "æ—©æ™¨", "big": "å¤§çš„", "long": "é•¿çš„"
                }
            },
            {
                text: "The {driver} is Mr. Brown. He is very {nice} to us.",
                cn: "å¸æœºæ˜¯å¸ƒæœ—å…ˆç”Ÿï¼Œä»–å¯¹æˆ‘ä»¬å¾ˆå‹å–„ã€‚",
                img: "images/story001_yellowbus/p2.jpg",
                vocab: { "driver": "å¸æœº", "nice": "å‹å¥½çš„" }
            },
            {
                text: "I {wait} for the bus at the bus {stop}. When the {door} {opens}, I see my {friends} {inside}.",
                cn: "æˆ‘åœ¨è½¦ç«™ç­‰è½¦ã€‚å½“è½¦é—¨æ‰“å¼€æ—¶ï¼Œæˆ‘çœ‹åˆ°æˆ‘çš„æœ‹å‹ä»¬åœ¨é‡Œé¢ã€‚",
                img: "images/story001_yellowbus/p3.jpg",
                vocab: { "wait": "ç­‰å¾…", "stop": "è½¦ç«™", "door": "é—¨", "opens": "æ‰“å¼€", "friends": "æœ‹å‹", "inside": "é‡Œé¢" }
            },
            {
                text: "We {sit} together and {look} out the {window}. We {talk} and {laugh} {happily}.",
                cn: "æˆ‘ä»¬ååœ¨ä¸€èµ·çœ‹çª—å¤–ã€‚æˆ‘ä»¬å¼€å¿ƒåœ°è¯´è¯å¤§ç¬‘ã€‚",
                img: "images/story001_yellowbus/p4.jpg",
                vocab: { "sit": "å", "look": "çœ‹", "window": "çª—æˆ·", "talk": "è¯´è¯", "laugh": "ç¬‘", "happily": "å¿«ä¹åœ°" }
            },
            {
                text: "The bus ride is {safe} and {fun}. I {love} the yellow bus.",
                cn: "åæ ¡è½¦æ—¢å®‰å…¨åˆæœ‰è¶£ã€‚æˆ‘çˆ±é»„è‰²æ ¡è½¦ã€‚",
                img: "images/story001_yellowbus/p5.jpg",
                vocab: { "safe": "å®‰å…¨çš„", "fun": "æœ‰è¶£çš„", "love": "çˆ±" }
            }
        ]
    };

    let rate = 1.0;
    let isPlaying = false;

    // === æ ¸å¿ƒä¿®å¤ï¼šç”¨æˆ·ç‚¹å‡»å¯åŠ¨åï¼Œè§£é”éŸ³é¢‘ ===
    function startApp() {
        document.getElementById('start-overlay').style.display = 'none';
        
        // å…³é”®æ“ä½œï¼šæ’­æ”¾ä¸€ä¸ªæ— å£°ç‰‡æ®µï¼Œéª—è¿‡ iOS çš„è‡ªåŠ¨æ’­æ”¾ç­–ç•¥
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let u = new SpeechSynthesisUtterance(''); 
            window.speechSynthesis.speak(u);
        }
        
        // åŠ è½½å†…å®¹
        render();
        activate(0);
    }

    function render() {
        const mid = document.getElementById('col-mid');
        mid.innerHTML = '';
        
        storyData.paragraphs.forEach((p, idx) => {
            let div = document.createElement('div');
            div.className = 'script-card';
            div.id = `p-${idx}`;
            div.onclick = (e) => {
                if(!e.target.classList.contains('highlight')) {
                    stopAuto();
                    activate(idx);
                }
            };

            let html = p.text.replace(/{(\w+)}/g, `<span class="highlight" onclick="readWord('$1', ${idx}, event)">$1</span>`);
            div.innerHTML = `<div class="en-text">${html}</div><div class="cn-text">${p.cn}</div>`;
            mid.appendChild(div);
        });
    }

    function activate(idx) {
        // UI é«˜äº®
        document.querySelectorAll('.script-card').forEach(e => e.classList.remove('active'));
        const card = document.getElementById(`p-${idx}`);
        if(card) {
            card.classList.add('active');
            card.scrollIntoView({behavior: "smooth", block: "center"});
        }

        // æ¢å›¾
        document.getElementById('scene-img').src = storyData.paragraphs[idx].img;

        // æ¢å•è¯
        const list = document.getElementById('vocab-list');
        list.innerHTML = '';
        const vocab = storyData.paragraphs[idx].vocab;
        for(let k in vocab) {
            let item = document.createElement('div');
            item.className = 'vocab-item';
            item.onclick = () => { stopAuto(); speak(k); };
            item.innerHTML = `<span class="vocab-word">${k}</span> <span class="vocab-cn">${vocab[k]}</span>`;
            list.appendChild(item);
        }

        // æœ—è¯»
        let cleanText = storyData.paragraphs[idx].text.replace(/{|}/g, "");
        speak(cleanText);
    }

    function readWord(word, idx, e) {
        e.stopPropagation();
        stopAuto();
        // ç¡®ä¿åˆ‡æ¢åˆ°å½“å‰æ®µè½çš„å›¾ç‰‡å’Œå•è¯è¡¨
        document.querySelectorAll('.script-card').forEach(el => el.classList.remove('active'));
        document.getElementById(`p-${idx}`).classList.add('active');
        document.getElementById('scene-img').src = storyData.paragraphs[idx].img;
        
        // æœ—è¯»å•è¯
        speak(word);
    }

    function speak(text, callback) {
        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = rate;
        if(callback) u.onend = callback;
        window.speechSynthesis.speak(u);
    }

    function setSpeed(v) {
        rate = v;
        document.querySelectorAll('.controls button').forEach(b => {
            b.classList.remove('active');
            if(b.innerText.includes(v)) b.classList.add('active');
        });
    }

    function toggleAuto() {
        if(isPlaying) stopAuto();
        else {
            isPlaying = true;
            document.getElementById('play-btn').innerText = "â¹";
            playNext(0);
        }
    }

    function stopAuto() {
        isPlaying = false;
        window.speechSynthesis.cancel();
        document.getElementById('play-btn').innerText = "â–¶ å…¨æ–‡";
    }

    function playNext(idx) {
        if(!isPlaying || idx >= storyData.paragraphs.length) {
            stopAuto();
            return;
        }
        activate(idx);
        let cleanText = storyData.paragraphs[idx].text.replace(/{|}/g, "");
        // è¿™é‡Œçš„speakä¸éœ€è¦å†æ¬¡è°ƒç”¨ï¼Œå› ä¸ºactivateé‡Œå·²ç»è°ƒäº†ã€‚
        // ä½†æ˜¯ä¸ºäº†æ•æ‰ onend äº‹ä»¶å®ç°è¿æ’­ï¼Œæˆ‘ä»¬éœ€è¦å•ç‹¬å¤„ç†
        window.speechSynthesis.cancel();
        let u = new SpeechSynthesisUtterance(cleanText);
        u.lang = 'en-US';
        u.rate = rate;
        u.onend = () => {
            if(isPlaying) setTimeout(() => playNext(idx+1), 800);
        };
        window.speechSynthesis.speak(u);
    }
</script>
</body>
</html>